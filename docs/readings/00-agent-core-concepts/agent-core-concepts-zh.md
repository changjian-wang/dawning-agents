# Agent æ ¸å¿ƒæ¦‚å¿µ Q&A

> Phase 0 è¡¥å……ææ–™
> æ·±å…¥ç†è§£ Agent çš„æœ¬è´¨ä¸å…³é”®é—®é¢˜

---

## Q1: Agent ä¸­çš„ messages æ˜¯ä»€ä¹ˆï¼Ÿ

### é—®é¢˜
```python
for msg in messages:
    self._chat_history.append(self._to_llm_message(msg))
```
è¿™é‡Œçš„ `messages` æ˜¯ç”¨æˆ·å‘çš„æ¶ˆæ¯å—ï¼Ÿå‘ç»™ LLM çš„æ¶ˆæ¯æ˜¯è¿­ä»£ç´¯ç§¯çš„å—ï¼Ÿ

### ç­”æ¡ˆ

**`messages` ä¸ä»…æ˜¯ç”¨æˆ·æ¶ˆæ¯**ï¼Œåœ¨å¤š Agent åœºæ™¯ä¸­å¯èƒ½æ¥è‡ªï¼š
- ç”¨æˆ·ï¼ˆåˆå§‹ä»»åŠ¡ï¼‰
- å…¶ä»– Agentï¼ˆåä½œå¯¹è¯ï¼‰
- Team ç¼–æ’å™¨ï¼ˆä¼ é€’ä¸Šä¸‹æ–‡ï¼‰

**æ˜¯çš„ï¼Œæ¶ˆæ¯ä¼šç´¯ç§¯å‘é€ï¼š**

```python
# æ¯æ¬¡è°ƒç”¨éƒ½å‘é€å®Œæ•´å†å²
llm_messages = []
if self._system_message:
    llm_messages.append(SystemMessage(content=self._system_message))
llm_messages.extend(self._chat_history)  # å®Œæ•´å†å²
```

```mermaid
graph TB
    subgraph "å‘ç»™ LLM çš„æ¶ˆæ¯"
        A[System Message] --> B[å†å²æ¶ˆæ¯ 1]
        B --> C[å†å²æ¶ˆæ¯ 2]
        C --> D[...]
        D --> E[æœ¬æ¬¡æ–°æ¶ˆæ¯]
    end
```

**åŸå› **ï¼šLLM API æ˜¯æ— çŠ¶æ€çš„ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ç‹¬ç«‹ï¼Œå¿…é¡»é‡å‘å†å²æ‰èƒ½ä¿æŒå¯¹è¯è¿è´¯ã€‚

---

## Q2: Agent çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

### é—®é¢˜
Agent æ˜¯ä¸æ˜¯å°±æ˜¯ä¸º LLM ç»„ç»‡ä¸Šä¸‹æ–‡çš„å·¥å…·ï¼Ÿ

### ç­”æ¡ˆ

**éƒ¨åˆ†æ­£ç¡®ï¼Œä½†ä¸å®Œæ•´ã€‚**

```text
å®Œæ•´å®šä¹‰: Agent = LLM + å¾ªç¯ + å·¥å…· + è‡ªä¸»å†³ç­–
```

| å¯¹æ¯” | æ™®é€š LLM è°ƒç”¨ | Agent |
|------|--------------|-------|
| è°ƒç”¨æ¬¡æ•° | 1 æ¬¡ | å¤šæ¬¡ï¼ˆå¾ªç¯ï¼‰ |
| å·¥å…·ä½¿ç”¨ | âŒ | âœ… |
| è‡ªä¸»å†³ç­– | âŒ åªå›ç­” | âœ… å†³å®šä¸‹ä¸€æ­¥ |
| çŠ¶æ€ç»´æŠ¤ | âŒ | âœ… |

### Agent çš„å®Œæ•´èŒè´£

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ä¸Šä¸‹æ–‡ç®¡ç† â† ä½ è¯´çš„è¿™éƒ¨åˆ†                                â”‚
â”‚     â€¢ ç»´æŠ¤å¯¹è¯å†å²                                          â”‚
â”‚     â€¢ ç»„ç»‡æ¶ˆæ¯æ ¼å¼                                          â”‚
â”‚                                                             â”‚
â”‚  2. å†³ç­–å¾ªç¯ â† å…³é”®åŒºåˆ«ï¼                                   â”‚
â”‚     â€¢ æ€è€ƒ â†’ å†³ç­– â†’ è¡ŒåŠ¨ â†’ è§‚å¯Ÿ â†’ é‡å¤                      â”‚
â”‚                                                             â”‚
â”‚  3. å·¥å…·ç¼–æ’                                                â”‚
â”‚     â€¢ çŸ¥é“æœ‰å“ªäº›å·¥å…·ï¼Œå†³å®šä½•æ—¶è°ƒç”¨                           â”‚
â”‚                                                             â”‚
â”‚  4. ç›®æ ‡è¿½è¸ª                                                â”‚
â”‚     â€¢ è®°ä½åŸå§‹ç›®æ ‡ï¼Œåˆ¤æ–­æ˜¯å¦å®Œæˆ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Q3: Agent å¦‚ä½•"æ€è€ƒ"ï¼Ÿ

### é—®é¢˜
Agent çš„æ€è€ƒä¸ä¹Ÿæ˜¯å€ŸåŠ© LLM å—ï¼Ÿ

### ç­”æ¡ˆ

**å®Œå…¨æ­£ç¡®ï¼Agent æœ¬èº«ä¸ä¼šæ€è€ƒï¼Œæ‰€æœ‰"æ€è€ƒ"éƒ½æ˜¯ LLM åœ¨åšã€‚**

```text
Agent æ¡†æ¶ = åªæ˜¯ä»£ç ï¼Œæ²¡æœ‰æ™ºèƒ½
LLM = çœŸæ­£çš„"å¤§è„‘"
```

### Agent æ¡†æ¶çš„çœŸæ­£ä»·å€¼

```python
class Agent:
    def run(self, task):
        while True:
            # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            # â”‚ è¿™ä¸€è¡Œ = å”¯ä¸€çš„"æ€è€ƒ"        â”‚
            # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            response = self.llm.chat(messages, tools)
            
            # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            # â”‚ ä¸‹é¢ = æ™®é€šä»£ç ï¼Œæ— æ™ºèƒ½      â”‚
            # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            if response.has_tool_call:
                result = self.execute_tool(response.tool)
                messages.append(result)
            else:
                return response.content
```

| Agent æ¡†æ¶åšçš„ | LLM åšçš„ |
|---------------|----------|
| ç»´æŠ¤æ¶ˆæ¯å†å² | ç†è§£æ„å›¾ |
| å¾ªç¯æ§åˆ¶ | å†³å®šè°ƒç”¨å“ªä¸ªå·¥å…· |
| æ‰§è¡Œå·¥å…· | åˆ†æç»“æœ |
| æ ¼å¼åŒ–æ¶ˆæ¯ | ç”Ÿæˆå›å¤ |

**æ¯”å–»**ï¼š
- LLM = å¤§è„‘ï¼ˆæ€è€ƒã€å†³ç­–ï¼‰
- Agent æ¡†æ¶ = èº«ä½“ï¼ˆæ‰§è¡Œå¤§è„‘æŒ‡ä»¤ï¼‰

---

## Q4: æ¶ˆæ¯ç´¯ç§¯å¯¼è‡´ Token é‡å¤æ¶ˆè´¹ï¼Ÿ

### é—®é¢˜
ç´¯ç§¯çš„ messages ä¼šå¯¼è‡´ token é‡å¤è®¡è´¹ï¼Œæœ‰è§£å†³åŠæ³•å—ï¼Ÿ

### ç­”æ¡ˆ

**é—®é¢˜ç¡®å®å­˜åœ¨ï¼š**

```text
ç¬¬1æ¬¡: [M1]           â†’ 1æ¡
ç¬¬2æ¬¡: [M1, M2]       â†’ 2æ¡ï¼ˆM1é‡å¤ï¼‰
ç¬¬3æ¬¡: [M1, M2, M3]   â†’ 3æ¡
...
ç¬¬Næ¬¡: [M1...MN]      â†’ Næ¡

æ€»è®¡è´¹ = 1+2+3+...+N = N(N+1)/2 â‰ˆ O(NÂ²) ğŸ”¥
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æ»‘åŠ¨çª—å£ï¼ˆæœ€å¸¸ç”¨ï¼‰

```python
class SlidingWindowMemory:
    def __init__(self, max_messages=10):
        self.max = max_messages
    
    def add(self, msg):
        self.messages.append(msg)
        if len(self.messages) > self.max:
            self.messages = self.messages[-self.max:]
```

- âœ… ç®€å•ï¼Œæˆæœ¬å¯æ§
- âŒ ä¸¢å¤±æ—©æœŸä¸Šä¸‹æ–‡

#### æ–¹æ¡ˆ 2: æ‘˜è¦è®°å¿†

```python
class SummaryMemory:
    def compress(self):
        # ç”¨ LLM æ€»ç»“æ—§æ¶ˆæ¯
        old = self.messages[:-3]
        self.summary = self.llm.summarize(old)
        self.messages = self.messages[-3:]
    
    def get_messages(self):
        return [
            SystemMessage(f"æ‘˜è¦: {self.summary}"),
            *self.messages
        ]
```

- âœ… ä¿ç•™å…³é”®ä¿¡æ¯
- âŒ æ€»ç»“æœ¬èº«æ¶ˆè€— token

#### æ–¹æ¡ˆ 3: å‘é‡æ£€ç´¢ï¼ˆRAGï¼‰

```python
class VectorMemory:
    def get_relevant(self, query, top_k=5):
        # åªæ£€ç´¢ç›¸å…³å†å²
        embedding = self.embed(query)
        return self.db.search(embedding, top_k)
```

- âœ… æŒ‰éœ€æ£€ç´¢ï¼Œé•¿å¯¹è¯ä¹Ÿèƒ½ä¿æŒç›¸å…³æ€§
- âŒ éœ€è¦å‘é‡æ•°æ®åº“

#### æˆæœ¬å¯¹æ¯”

| æ–¹æ¡ˆ | 10è½®å¯¹è¯ | 100è½®å¯¹è¯ |
|------|----------|-----------|
| æ— ä¼˜åŒ– | 55x | 5050x |
| æ»‘åŠ¨çª—å£ | ~50x | ~500x |
| æ‘˜è¦è®°å¿† | ~30x | ~150x |
| å‘é‡æ£€ç´¢ | ~20x | ~200x |

---

## Q5: RAG + Agent æ˜¯å¦ä¸»æµï¼Ÿ

### ç­”æ¡ˆ

**æ˜¯çš„ï¼ŒRAG + Agent æ˜¯ç›®å‰æœ€ä¸»æµçš„ç”Ÿäº§æ¶æ„ã€‚**

```mermaid
graph LR
    subgraph "RAG + Agent"
        U[ç”¨æˆ·] --> A[Agent]
        A --> V[å‘é‡æ£€ç´¢]
        V --> K[çŸ¥è¯†åº“]
        K --> V
        V --> A
        A --> L[LLM]
        L --> A
        A --> T[å·¥å…·]
        T --> A
        A --> R[å›ç­”]
    end
```

| èƒ½åŠ› | çº¯ LLM | RAG | Agent | RAG+Agent |
|------|--------|-----|-------|-----------|
| çŸ¥è¯†æ›´æ–° | âŒ | âœ… | âŒ | âœ… |
| ç§æœ‰æ•°æ® | âŒ | âœ… | âŒ | âœ… |
| æ‰§è¡Œæ“ä½œ | âŒ | âŒ | âœ… | âœ… |
| å¤šæ­¥æ¨ç† | âŒ | âŒ | âœ… | âœ… |

---

## Q6: æœ‰å“ªäº›å‘é‡æ•°æ®åº“ï¼Ÿå¯ä»¥æœ¬åœ°å®‰è£…å—ï¼Ÿ

### ç­”æ¡ˆ

**å¯ä»¥æœ¬åœ°å®‰è£…ï¼**

#### æ¨èï¼ˆæœ¬åœ°å®‰è£…ï¼‰

| æ•°æ®åº“ | å®‰è£…éš¾åº¦ | ç‰¹ç‚¹ |
|--------|----------|------|
| **Chroma** | â­ æœ€ç®€å• | `pip install chromadb` |
| **LanceDB** | â­ | åµŒå…¥å¼ï¼Œæ— éœ€æœåŠ¡å™¨ |
| **Qdrant** | â­â­ | Docker ä¸€é”®å¯åŠ¨ï¼Œæœ‰ .NET SDK |
| **pgvector** | â­â­ | PostgreSQL æ‰©å±• |
| **Milvus** | â­â­â­ | ä¼ä¸šçº§ |

#### å¿«é€Ÿä¸Šæ‰‹ç¤ºä¾‹ï¼ˆChromaï¼‰

```python
pip install chromadb
```

```python
import chromadb

client = chromadb.PersistentClient(path="./db")
collection = client.create_collection("docs")

# æ·»åŠ 
collection.add(
    documents=["ä»Šå¤©å¤©æ°”å¥½", "æ˜å¤©ä¸‹é›¨"],
    ids=["doc1", "doc2"]
)

# æŸ¥è¯¢
results = collection.query(query_texts=["å¤©æ°”"], n_results=2)
```

#### é€‰æ‹©å»ºè®®

```text
å¼€å‘/å­¦ä¹ : Chroma æˆ– LanceDBï¼ˆæœ€ç®€å•ï¼‰
.NET ç”Ÿæ€: Qdrant æˆ– pgvector
ç”Ÿäº§ç¯å¢ƒ: Qdrant / Milvus / Pinecone
å·²æœ‰ PG: pgvector
```

---

## æ€»ç»“

| æ¦‚å¿µ | æ ¸å¿ƒç†è§£ |
|------|----------|
| Agent æ¶ˆæ¯æµ | æ¯æ¬¡å‘é€å®Œæ•´å†å²ï¼Œå› ä¸º LLM æ— çŠ¶æ€ |
| Agent æœ¬è´¨ | å¾ªç¯ + å·¥å…· + ä¸Šä¸‹æ–‡ç®¡ç† |
| Agent æ€è€ƒ | å…¨é  LLMï¼Œæ¡†æ¶åªæ˜¯æ‰§è¡Œå™¨ |
| Token ä¼˜åŒ– | æ»‘åŠ¨çª—å£ / æ‘˜è¦ / å‘é‡æ£€ç´¢ |
| ä¸»æµæ¶æ„ | RAG + Agent |
| å‘é‡æ•°æ®åº“ | Chroma/LanceDB å…¥é—¨ï¼ŒQdrant ç”Ÿäº§ |
